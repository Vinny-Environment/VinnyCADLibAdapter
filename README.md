# VinnyCADLibAdapter

Adapter for CSoft CADLib: Модель и Архив

РАЗРАБОТКА ОСТАНОВЛЕНА (см. TODO)

# Установка

Файлы плагина к CSoft CADLib: Модель и Архив расположены в папке `plugins\cadlib` пакета `VinnyLibConverter`(см. [здесь](https://github.com/Vinny-Environment/VinnyLibConverter#%D1%83%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0))
Плагин может быть установлен одинаково на версии стандартного CADLib и CADLib DX.
Плагин разрабатывался и тестировался на версии CADLib 3.2.520.2899 (декабрь 2023г).

Для загрузки плагина в CADLib необходимы права администратора (если путь установки CADLib системный по умолчанию в `C:\Program Files...`).

1. Зайти в текстовый файл `C:\Program Files (x86)\CSoft\Model Studio CS\Viewer\bin\x64\plugins.xml`;
2. Добавить в конце в блок `Plugins` новую запись вида `<Plugin name="C:\Users\Georg\Documents\GitHub\VinnyLibBin\Debug\plugins\cadlib\VinnyCADLibLoader.dll" />`, где путь в кавычках указать полный файловый путь к библиотеке `VinnyCADLibLoader.dll` в Вашей папке с развернутым дистрибутивом VinnyLibConverter.
3. Сохранить файл и перезапустить CADLib.

Для CADLib DX действия аналогичны.
Если всё сделано корректно, то в CADLib появится лента `Vinny` с двумя командами на импорт и экспорт данных, активных при загрузке какой-либо модели и справочная команда "О плагине".

# Использование

## Импорт

Импорт модели осуществляется в новую площадку по умолчанию, имя которой = имени входящего файла. Далее объекты лежат в одной группе. Автоматически преобразовать иерархию элементов в иерархию структуры CADLib не представляется возможным.

### Указание структуры

Для явного указания, какой объект обрабатываемого файла соответствует структурному уровню модели CADLib, у объекта должен иметься параметр **VinnyCADLibStructure**, значение которого должно содержать привязку к названию структурной единицы CADLib. Перечень возможных названий представлен ниже, для удобства оформлен как словарь JSON. Значения в кавычках соответствуют оригинальным в CADLib (отображаемое значение в значении параметра **Уровень иерархии**); вам необходимо использовать названия уровней на латинице (регистр важен).

Вложенность уровней должна также соответствовать принятой в CADLib (например, этаж (LEVEL) не может быть вложен в площадку (SITE) и т.д).

```json
{
	"SITE":"1. Площадка (Генплан)",
	"BUILDING":"2. Здание (Сооружение)",
	"LEVEL":"3. Этаж",
	"ROOM":"4. Помещение (Зона)",
	"BLOCK":"5. Блок (Узел)",
	"STAGE":"6. Стадия",
	"DISCIPLINES":"7. Разделы проекта",
	"DISCIPLINE":"8. Раздел",
	"CHAPTER":"9. Подраздел",
	"PART":"10. Часть",
	"GRP_BLD":"11. Группа зданий(сооружений)",
	"SYSTEM":"12. Система",
	"SUBSYSTEM":"13. Подсистема",
	"EQUIPMENT":"14. Оборудование",
	"LINE":"15. Линия",
	"GROUP_EQUIPMENT":"16. Группа оборудования",
	"UNION":"17. Штуцер(Люк)",
	"TERMINAL_BLOCK":"18. Клеммник",
	"TERMINAL":"19. Клемма",
	"PIPELINE":"20. Трубопровод",
	"PIPELINE_AXIS":"21. Участок",
	"CABLE":"22. Кабель",
	"CABLE_CORE":"23. Жила",
	"CONNECTION":"24. Подключение",
	"LINEAR_EQUIPMENT":"25. Линейное оборудование",
	"PIPLINE_FITTINGS":"26. Арматура",
	"SITUATION":"27. Ситуация",
	"SYSTEMS":"28. Системы",
	"CONSTRUCTIONS":"29. Конструкции",
	"DIFFERENT":"30. Разное",
	"EQUIPMENT_LINK":"31. Cсылка на оборудование",
	"FITTINGS_LINK":"32. Cсылка на арматуру",
	"LINEAR_EQUIPMENT_LINK":"33. Ссылка на линейное оборудование",
	"CONTROL":"34. Контроль",
	"SECTION":"35. Раздел",
	"SUBSECTION":"36. Подраздел",
	"GROUP":"37. Группа",
	"SUBGROUP":"38. Подгруппа",
	"TYPE":"39. Тип",
	"SUBTYPE":"40. Подтип",
	"ACCOUNT_ASM":"41. Учетная сборка",
	"ACCOUNT_OBJ":"42. Учетный объект",
	"SEGMENT":"43. Сегмент",
	"REDUCER":"44. Переход",
	"CABINET":"45. Шкаф",
	"DEVICE":"46. Прибор",
	"DEVICE_BLOCK":"47. Блок",
	"SECTION_CABINETS":"48. Секция",
	"BUS":"49. Шина",
	"ROOM_AREA":"50. Зона помещения",
	"BUILDING_BLOCK":"51. Блок зданий (Сооружений)",
	"MULTI_SECTION_BUILDING":"52. Многосекционное здание (Cооружение)",
	"SECTION_BUILDING":"53. Секция зданий (Сооружений)",
	"ROOM_FROUP":"54. Группа помещений",
	"ELEVATION":"55. Уровень"
}
```

### Указание типа (категории) объекта

Тип (категория) объекта CADLib по умолчанию для создаваемых объектов будет пользовательский "VinnyObject". 

При желании переопределить тип (категорию), используйте параметр **VinnyCADLibObjectType**, значением которого должно выступать один из типов (категорий) объектов для используемой БД. Перечень категорий объектов см. в таблице БД CADLib "ObjectCategories", используйте поле Name для отдельной записи таблицы "ObjectCategories", указывая его в значении параметра **VinnyCADLibObjectType** у соответствующего объекта.

Основные категории приведены в перечне ниже (ключом словаря выступает Name, а значением -- Caption таблицы ObjectCategories)

```json
{
  "structure_data": "Структурные данные",
  "COLLISIONS": "Коллизии",
  "garlands": "Гирлянды",
  "climate": "Климат",
  "nodes": "Контакты",
  "assemblies": "Сборки",
  "garlandMisc": "Детали гирлянд",
  "suppressor": "Гасители вибрации",
  "units": "Оборудование",
  "towerequipment": "Комплект оборудования",
  "TowerSettings": "Настройки параметров опор",
  "metalware": "Металлоконструкции",
  "WorkList": "Перечень работ",
  "symbol": "Элемент схемы",
  "gesnCategoryList": "ГЭСН (шифры)",
  "decoration": "Элементы оформления",
  "HVAC": "Вентиляция",
  "gesnResourceItem": "ГЭСН (ресурсы)",
  "pipeLineNumberList": "Справочник наименований линий",
  "OptionsList": "Настройки мастера построений",
  "aec_elements": "Строительные элементы",
  "catMaterial": "Каталог материалов",
  "ground": "Грунт",
  "WorkItem": "Объем работ",
  "AEC_SURF": "Строительная поверхность",
  "foundation": "Фундамент",
  "report": "Отчет",
  "cables": "Кабели",
  "HVACAxis": "Осевая вентиляции",
  "metalwarenode": "Узел Металлоконструкций",
  "hierarchical_list": "Иерархический список",
  "device": "Прибор",
  "wires": "Провода",
  "iron_assemblies": "Сборки металлоконструкций",
  "TRAYS": "Кабельные конструкции",
  "aec_layer_groups": "Набор строительных слоев",
  "wire": "Провод",
  "catMaterials": "Классификатор материалов",
  "REINFORCEMENT": "Строительная арматура",
  "node": "Контакт",
  "routeConstructionsAssemblies": "Сборки прототипов",
  "routeConstructions": "Конструкции прототипов",
  "aec_layer_material": "Строительный слой",
  "cat47": "Железобетонные конструкции",
  "concreteware": "Железобетонные изделия",
  "Materials": "Материалы",
  "commonLinks": "Нетрубопроводные связи",
  "tank_eq_schm": "Элементы оборудования схем",
  "pipeMaterialList": "Каталог материалов",
  "catDiameterList": "Перечень диаметров",
  "assembly": "Сборка",
  "cabinet": "Щит",
  "label": "Надпись",
  "panels": "Панели шкафа",
  "Cable_ETS": "Кабель_ЭТС",
  "WireDefault": "Другие провода",
  "valve_prototype": "Прототип комплекта",
  "pipeAxis": "Осевая трубопровода",
  "bolts": "Крепежные изделия",
  "pipeItems": "Детали трубопроводов",
  "tank_equip": "Элементы оборудования",
  "pipeCategoryList": "Категории трубопровода",
  "Insulation": "Изоляция",
  "zoneList": "Классификатор зданий и сооружений",
  "catPipeSupportStepData": "Трубопроводы. Шаг опор",
  "catLineSystems": "Классификатор систем",
  "cat_clash": "Стандартные проверки",
  "HVACPipeItems": "Компоненты вентиляции",
  "AEC_WALL": "Стена"
}
```

## Экспорт

Функция экспорта на данный момент работает не корректно (вы, конечно, можете ей воспользоваться).
Проблемы с чтением геометрии CSMesh (некорректная триангуляция). Проблема с получением иерархии по структуре (поэтому экспортируются ВСЕ данные модели CADLib)

# Dev

Состоит из двух проектов:

* `VinnyCADLibLoader`: загрузчик в CADLib;
* `VinnyCADLibAdapter`: основная логика плагина;

В проектах используются внешние зависимости на библиотеки CADLib `C:\Program Files (x86)\CSoft\Model Studio CS\Viewer\bin\x64\`;

# TODO

Решить ошибки API на экспорт (структура и геометрия)
